<!DOCTYPE html>
<html>
  <head>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="handlebars-v1.3.0.js"></script>
    <script src="units.js"></script>
    <script src="quantities.js"></script>
    <title>LikeThisMuch.com</title>
    <script id="result-template" type="text/x-handlebars-template">
      <li class="result">
        <span class="description">{{ description.[0] }}</span><!--
     --><span class="quantity">{{ quantity }}</span><!--
     --><span class="description">{{ description.[1] }}</span>
      </li>
    </script>
  </head>
  <body>
    <input class="query-input" type="text" name="query"></input>
    <div class="interpretation">
      Interpreted as: <span class="quantity"></span> <span class="unit"></span>
    </div>
    is like
    <button class="query-button">this much</button>
    <ul class="results"></ul>
  </body>
  <script>
    var resultTemplate;


    $(function() {
      resultTemplate = Handlebars.compile($("#result-template").html());

      $('.query-button').click(handleQuery);
      $(document).keydown(function(e) { if (e.which == 13) handleQuery(); });
    });


    function handleQuery() {
      // TODO: Handle errors appropriately.

      $('.query-input, .query-button').prop('disabled', true);
      
      var standardizedQuery = parseAndStandardize($('.query-input').val());

      $('.interpretation .quantity').text(standardizedQuery[0]);
      $('.interpretation .unit').text(standardizedQuery[0] == 1 ?
                                      standardizedQuery[1].singularLongName :
                                      standardizedQuery[1].pluralLongName);

      convertAndRender.apply(null, standardizedQuery);
      
      $('.query-input, .query-button').prop('disabled', false);
    }


    function parseAndStandardize(query) {
      // Floating point regex mostly from http://www.regular-expressions.info/floatingpoint.html.
      var matches = /^([-+]?[0-9,\s]*\.?[0-9,\s]+(?:[eE][-+]?[0-9,\s]+)?)\s*(.*?)\s*$/.exec(query);
      if (!matches) {
        throw new Error('Unparseable query.');
      }

      var initialQuantity = parseFloat(matches[1].replace(/[,\s]/g, ''));
      if (isNaN(initialQuantity)) {
        throw new Error('Unparseable quantity.'); 
      }

      var initialUnitString = matches[2].replace(/[*.^\s\u00B7]+/g, '');
      var initialUnit = UNITS[initialUnitString] || UNITS[initialUnitString.toLowerCase()];
      if (!initialUnit) {
        throw new Error('Unrecognized unit ' + initialUnitString);
      }

      console.debug(initialQuantity + ' ' + initialUnitString);

      var rootQuanitity = initialQuantity;
      var rootUnit = initialUnit;
      do {
        rootQuanitity *= rootUnit.multiplier || 1;
        rootUnit = UNITS[rootUnit.unit];
        if (!initialUnit.shortName && rootUnit.shortName) {
          initialUnit = rootUnit;
        }

        console.debug(' = ' + rootQuanitity + ' ' + rootUnit.shortName);
      } while (rootUnit.multiplier != 1);

      return [initialQuantity, initialUnit, rootQuanitity, rootUnit];
    }


    function convertAndRender(initialQuantity, initialUnit, rootQuanitity, rootUnit) {
      var relevantKnownQuantities = KNOWN_QUANTITIES[rootUnit.shortName];

      var $results = $('.results');
      $results.html('');
      for (var i = 0; i < relevantKnownQuantities.length; ++i) {
        $results.append(resultTemplate({
          quantity: rootQuanitity / relevantKnownQuantities[i].quantity,
          description: relevantKnownQuantities[i].description.split('|')
        }));
      }
    }
  </script>
</html>
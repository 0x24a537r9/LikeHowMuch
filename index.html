<!DOCTYPE html>
<html>
  <head>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="units.js"></script>
    <script src="quantities.js"></script>
    <script src="counters.js"></script>
    <title>LikeThisMuch.com</title>
  </head>
  <body>
    <input class="query-input" type="text" name="query"></input>
    <div class="interpretation">
      Interpreted as: <span class="quantity"></span> <span class="unit"></span>
    </div>
    is like
    <button class="query-button">this much</button>
    <div class="result">
      <span class="quantity"></span> <span class="unit"></span>
    </div>
  </body>
  <script>
    $(function() {
      $('.query-button').click(handleQuery);
      $(document).keydown(function(e) { if (e.which == 13) handleQuery(); });
    });


    function handleQuery() {
      // TODO: Handle errors appropriately.

      $('.query-input, .query-button').prop('disabled', true);
      
      var standardizedQuery = parseAndStandardize($('.query-input').val());

      $('.interpretation .quantity').text(standardizedQuery[0]);
      $('.interpretation .unit').text(standardizedQuery[0] == 1 ?
                                      standardizedQuery[1].singularLongName :
                                      standardizedQuery[1].pluralLongName);

      var convertedQuery = convert.apply(null, standardizedQuery);

      $('.result .quantity').text(convertedQuery[0]);
      $('.result .unit').text(convertedQuery[1]);
      
      $('.query-input, .query-button').prop('disabled', false);
    }


    function parseAndStandardize(query) {
      // Floating point regex mostly from http://www.regular-expressions.info/floatingpoint.html.
      var matches = /^([-+]?[0-9,]*\.?[0-9,]+(?:[eE][-+]?[0-9]+)?)\s*(.*?)\s*$/.exec(query);
      if (!matches) {
        throw new Error('Unparseable query.');
      }

      var initialQuantity = parseFloat(matches[1]);
      if (isNaN(initialQuantity)) {
        throw new Error('Unparseable quantity.'); 
      }

      var initialUnitString = matches[2].replace(/[*.^\s\u00B7]+/g, '');
      var initialUnit = UNITS[initialUnitString] || UNITS[initialUnitString.toLowerCase()];
      if (!initialUnit) {
        throw new Error('Unrecognized unit ' + initialUnitString);
      }

      console.debug(initialQuantity + ' ' + initialUnitString);

      var rootQuanitity = initialQuantity;
      var rootUnit = initialUnit;
      do {
        rootQuanitity *= rootUnit.multiplier || 1;
        rootUnit = UNITS[rootUnit.unit];
        if (!initialUnit.shortName && rootUnit.shortName) {
          initialUnit = rootUnit;
        }

        console.debug(' = ' + rootQuanitity + ' ' + rootUnit.shortName);
      } while (rootUnit.multiplier != 1);

      return [initialQuantity, initialUnit, rootQuanitity, rootUnit];
    }


    function convert(initialQuantity, initialUnit, rootQuanitity, rootUnit) {
      var relevantKnownQuantities = KNOWN_QUANTITIES[rootUnit.shortName];
      for (var i = relevantKnownQuantities.length - 1; i >= 0; --i) {
        if (relevantKnownQuantities[i].quantity <= rootQuanitity || i == 0) {
          var knownQuantity =
              getElementAtIndexWithAlternatingOffset(relevantKnownQuantities, i,
                                                     incCounter(initialQuantity, initialUnit)) ||
              relevantKnownQuantities[i + resetCounter(initialQuantity, initialUnit)];

          return [
            rootQuanitity / knownQuantity.quantity,
            knownQuantity.description
          ];
        }
      }
    }


    function getElementAtIndexWithAlternatingOffset(array, i, offset) {
      if (i - Math.floor(offset / 2) < 0) {
        return array[offset];
      } else if (i + Math.ceil(offset / 2) >= array.length) {
        return array[array.length - offset - 1];
      } else {
        if (offset % 2 == 0) {
          return array[i - Math.floor(offset / 2)];
        } else {
          return array[i + Math.ceil(offset / 2)];
        }
      }
    }
  </script>
</html>
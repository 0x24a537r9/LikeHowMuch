<!DOCTYPE html>
<html>
  <head>
    <title>LikeHowMuch.com</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
    <link href='//fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'>
    <link href="reset.css" rel="stylesheet" type="text/css">
    <link href="base.css" rel="stylesheet" type="text/css">
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="underscore.js"></script>
    <script src="textFit.min.js"></script>
    <script src="handlebars-v1.3.0.js"></script>
    <script src="units.js"></script>
    <script src="quantities.js"></script>
    <script src="banner.js"></script>
    <script id="result-template" type="text/x-handlebars-template">
      <li class="result">
        <span class="description">{{ description.[0] }}</span><!--
     --><span class="quantity">{{ quantity }}</span><!--
     --><span class="description">{{ description.[1] }}</span>
      </li>
    </script>
  </head>
  <body>
    <div class="content">
      <h1 class="how-much-is-caption">
        <div>How much is</div>
      </h1>
      <div class="query-form">
        <ul class="placeholder-container">
          <li>19,000 mph
          <li>5 TB
          <li>4.3e9 years
          <li>3 lb.
          <li>4000 yards
          <li>1 tsp.
          <li>0.0000000972m
          <li>2 fortnights
          <li>18 gallons
          <li>14 microseconds
          <li>$43,000,000
          <li>500 bushels
          <li>0.2 light years
          <li>12 parsecs
          <li>83 mL
          <li>1,804,000 metric tons
          <li>527 square km
          <li>2.341e-13 meters
          <li>43"
          <li>500,000 km/h
        </ul>
        <input class="query-input" type="text" name="query"></input>
        <button class="query-button">=</button>
      </div>
      <div class="interpretation">
        Interpreted as: <span class="quantity"></span> <span class="unit"></span>
      </div>
      <h1 class="is-like-caption">
        is like...
      </h1>
      <hr class="fade-0">
      <ul class="results"></ul>
      <hr class="fade-1">
      <a href="https://github.com/0x24a537r9/LikeThisMuch">
        <img class="fork-me-banner"
             src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67"
             alt="Fork me on GitHub"
             data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png">
      </a>
      <div class="banner"><div class="banner-text"></div></div>
      <div class="banner"><div class="banner-text"></div></div>
    </div>
  </body>
  <script>
    var resultTemplate;
    var placeholderTimer;
    var isFirstQuery = true;


    $(function() {
      resultTemplate = Handlebars.compile($("#result-template").html());

      $('.query-button').click(handleQuery);
      $(document).keydown(function(e) { if (e.which == 13) handleQuery(); });

      placeholderTimer = setInterval(handlePlaceholderTimerTick, 1500);
      setTimeout(handlePlaceholderTimerTick, 0);
      $('.query-input').focus(function() {
        clearInterval(placeholderTimer);
        $('.placeholder-container').addClass('hidden');
      });

      var resizeTimeout;
      $(window).resize(function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(fitResults, 50);
      });
    });


    function handlePlaceholderTimerTick() {
      var $placeholderContainer = $('.placeholder-container');
      var placeholders = $placeholderContainer.children().length;
      var i = Math.random() * placeholders | 0;
      $placeholderContainer.css('transform', 'translateY(' + (i * -100 / placeholders) + '%)');
    }


    function handleQuery() {
      var query = $('.query-input').val().trim();
      if (!query) {
        return;
      }

      $('.query-input').blur();
      $('.query-input, .query-button').prop('disabled', true);

      try {
        var standardizedQuery = parseAndStandardize(query);
        if (ga != null) {
          ga('send', 'event', 'input', 'query', standardizedQuery[3].shortName);
        }

        $('.interpretation .quantity').text(formatQuantity(standardizedQuery[0]));
        $('.interpretation .unit').text(standardizedQuery[0] == 1 ?
                                        standardizedQuery[1].singularLongName :
                                        standardizedQuery[1].pluralLongName);

        convertAndRender.apply(null, standardizedQuery);
      } catch (e) {
        showBannerMessage(e.message);
        if (ga != null) {
          ga('send', 'event', 'input', 'error', query);
        }
      }

      $('.query-input, .query-button').prop('disabled', false);

      isFirstQuery = false;
    }


    function parseAndStandardize(query) {
      // TODO: Add support for "X billion"-like quantities.
      // TODO: Add support for "1/4"-like quantities.
      // Floating point regex mostly from http://www.regular-expressions.info/floatingpoint.html.
      var matches = /^([0-9,\s]*\.?[0-9,\s]+(?:[eE][-+]?[0-9,\s]+)?)\s*(.*?)\s*$/.exec(query);
      if (!matches) {
        matches = /^([^0-9.]*?)([0-9,\s]*\.?[0-9,\s]+(?:[eE][-+]?[0-9,\s]+)?)$/.exec(query);
        if (!matches) {
          throw new Error('Huh. I don\'t recognize that measurement...');
        }
        var swap = matches[1];
        matches[1] = matches[2];
        matches[2] = swap;
      }

      var initialQuantity = parseFloat(matches[1].replace(/[,\s]/g, ''));
      if (isNaN(initialQuantity)) {
        throw new Error('Uh... are you sure that\'s a real number?');
      }

      var initialUnitString = matches[2].replace(/[*.^\s\u00B7]+/g, '');
      if (!initialUnitString) {
        throw new Error('I\'m gonna need a unit of measurement (e.g. "meters").');
      }

      var initialUnit = UNITS[initialUnitString] || UNITS[initialUnitString.toLowerCase()];
      if (!initialUnit) {
        throw new Error('Sorry. I don\'t know what "' + matches[2] + '" are :(');
      }

      console.debug(initialQuantity + ' ' + initialUnitString);

      var rootQuanitity = initialQuantity;
      var rootUnit = initialUnit;
      do {
        rootQuanitity *= rootUnit.multiplier || 1;
        rootUnit = UNITS[rootUnit.unit];
        if (!initialUnit.shortName && rootUnit.shortName) {
          initialUnit = rootUnit;
        }

        console.debug(' = ' + rootQuanitity + ' ' + rootUnit.shortName);
      } while (!isRootUnit(rootUnit));

      return [initialQuantity, initialUnit, rootQuanitity, rootUnit];
    }


    function convertAndRender(initialQuantity, initialUnit, rootQuanitity, rootUnit) {
      var relevantKnownQuantities = KNOWN_QUANTITIES[rootUnit.shortName];
      var mostRelevantQuantityIndex = 0;

      var $results = $('.results');
      $results.html('');
      for (var i = 0; i < relevantKnownQuantities.length; ++i) {
        $results.append(resultTemplate({
          quantity: formatQuantity(rootQuanitity / relevantKnownQuantities[i].quantity),
          description: relevantKnownQuantities[i].description.split('|')
        }));
        if (rootQuanitity >= relevantKnownQuantities[i].quantity) {
          mostRelevantQuantityIndex = i;
        }
      }

      fitResults();
      
      var flashDelay = isFirstQuery ? 1300 : 0;
      setTimeout(function() {
        scrollToResult(mostRelevantQuantityIndex);
      }, flashDelay)
      setTimeout(function() {
        $('.results li').eq(mostRelevantQuantityIndex).addClass('flash');
      }, flashDelay + 500);
      setTimeout(function() {
        $('.results li').eq(mostRelevantQuantityIndex).removeClass('flash')
      }, flashDelay + 1000);

      $('.content').addClass('show-results');
    }


    function formatQuantity(n) {
      var FRACTION_DIGITS = 4;
      var nParts = n.toExponential(FRACTION_DIGITS).split('e');
      var baseStr = nParts[0].replace('.', '');
      var exp = parseInt(nParts[1]);

      var intStr = baseStr;
      intStr = intStr.substr(0, exp + 1);  // Remove fractional digits.
      intStr += _.times(exp - FRACTION_DIGITS, function() { return '0'; }).join('');  // Append 0s.
      intStr = intStr.replace(/\B(?=(\d{3})+(?!\d))/g, ',');  // Insert commas.
      intStr = intStr || '0';  // Make 0 if empty.

      var fracStr = baseStr;
      fracStr = fracStr.substr(Math.max(0, exp + 1));  // Remove integral digits.
      fracStr = _.times(-exp - 1, function() { return '0'; }).join('') + fracStr;  // Prepend 0s.

      return (intStr + '.' + fracStr).replace(/\.?0*$/, '');
    }


    function fitResults() {
      $('.textFitted').css('height', '');  // Fix for a bug in the textFit library.
      $('.results li').each(function() {
        textFit(this, {
          alignHoriz: true,
          alignVert: true,
          multiLine: true,
          reProcess: true,
          maxFontSize: 48
        });
      });
    }


    function scrollToResult(i) {
      var $results = $('.results');
      $results.animate({scrollTop: i * 200 - ($results.height() - 200) / 2 + 25}, 500);
    }
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-80281226-1', 'auto');
    ga('send', 'pageview');
  </script>
</html>
